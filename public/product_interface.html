<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product Interface - StudXchange</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.1/css/all.min.css" />
  <script src="js/db-config.js"></script>
  <style>
    :root {
      --primary-color: #2a3d56;
      --secondary-color: #2a3d56;
      --accent-color: #1a75ff;
      --text-color: #333;
      --bg-color: #f4f6f9;
      --white-color: #fff;
      --shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background-color: var(--primary-color);
      color: var(--white-color);
      padding: 1rem;
      text-align: center;
      box-shadow: var(--shadow);
    }

    main {
      flex: 1;
      padding: 2rem;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    .product-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      background: var(--white-color);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 2rem;
    }

    .product-images {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .main-image-container {
      width: 100%;
      height: 400px;
      border-radius: 12px;
      overflow: hidden;
      background-color: #eaeaea;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .main-image-container.loading::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1;
    }

    .main-image-container.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 40px;
      border: 4px solid var(--accent-color);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      z-index: 2;
    }

    .main-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .main-image.loaded {
      opacity: 1;
    }

    .thumbnails {
      display: flex;
      gap: 0.75rem;
      overflow-x: auto;
      padding: 0.5rem 0;
    }

    .thumbnail {
      flex: 0 0 auto;
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      cursor: pointer;
      transition: transform 0.2s, opacity 0.2s;
    }

    .thumbnail:hover {
      transform: scale(1.05);
      opacity: 0.8;
    }

    .product-details {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .product-header {
      border-bottom: 1px solid #ddd;
      padding-bottom: 1rem;
    }

    .product-title {
      font-size: 2rem;
      color: var(--secondary-color);
      margin-bottom: 0.5rem;
    }

    .price-section {
      display: flex;
      align-items: baseline;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .current-price {
      font-size: 1.75rem;
      color: var(--accent-color);
      font-weight: bold;
    }

    .original-price {
      color: #777;
      text-decoration: line-through;
      font-size: 1rem;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      margin: 1rem 0;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background-color: var(--accent-color);
      color: var(--white-color);
    }

    .btn-secondary {
      background-color: var(--secondary-color);
      color: var(--white-color);
    }

    .btn:hover {
      transform: scale(1.02);
    }

    .product-description {
      margin: 2rem 0;
      line-height: 1.6;
    }

    .product-description p {
      line-height: 1.6;
      font-size: 1rem;
    }

    footer {
      background-color: var(--primary-color);
      color: var(--white-color);
      text-align: center;
      padding: 1.5rem;
      margin-top: auto;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: var(--white-color);
      padding: 2rem;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      position: relative;
      box-shadow: var(--shadow);
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      cursor: pointer;
      font-size: 1.5rem;
    }

    .buyer-info {
      display: grid;
      gap: 1rem;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .input-group input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }

    @media (max-width: 768px) {
      .product-container {
        grid-template-columns: 1fr;
      }
      .main-image-container {
        height: 300px;
      }
    }

    /* Map styles */
    .map-card {
      background: var(--white-color);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 1rem;
      margin-top: 2rem;
    }

    .map-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .map-controls {
      display: flex;
      gap: 0.5rem;
    }

    .map-control-btn {
      background: var(--white-color);
      border: 1px solid var(--secondary-color);
      border-radius: 4px;
      padding: 0.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .map-control-btn:hover {
      background: var(--accent-color);
      color: var(--white-color);
      border-color: var(--accent-color);
    }

    #map {
      width: 100%;
      height: 400px;
      border-radius: 8px;
      overflow: hidden;
    }

    #mapError {
      background-color: #ffebee;
      color: #c62828;
      padding: 1rem;
      border-radius: 4px;
      margin: 0.5rem 0;
      text-align: center;
      display: none;
    }

    .map-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 400px;
      background: var(--white-color);
      border-radius: 8px;
    }

    .map-loading .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--accent-color);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    .map-loading p {
      color: var(--text-color);
      font-size: 1rem;
    }

    /* Loading animation */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Chat styles */
    .chat-box {
      height: 300px;
      overflow-y: auto;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .message {
      margin-bottom: 1rem;
      max-width: 80%;
    }

    .user-message {
      margin-left: auto;
    }

    .seller-message {
      margin-right: auto;
    }

    .message-content {
      padding: 0.75rem;
      border-radius: 8px;
      background-color: var(--bg-color);
    }

    .user-message .message-content {
      background-color: var(--accent-color);
      color: var(--white-color);
    }

    .chat-input {
      display: flex;
      gap: 0.5rem;
    }

    .chat-input input {
      flex: 1;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }

    .chat-input button {
      padding: 0.75rem 1.5rem;
      background-color: var(--accent-color);
      color: var(--white-color);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .chat-input button:hover {
      background-color: var(--secondary-color);
    }

    /* Product comparison styles */
    .product-list {
      max-height: 300px;
      overflow-y: auto;
      margin: 1rem 0;
    }

    .product-item {
      display: flex;
      gap: 1rem;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .product-item:hover {
      background-color: var(--bg-color);
    }

    .product-item img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 4px;
    }

    .product-info {
      flex: 1;
    }

    .product-info h4 {
      margin: 0;
      font-size: 1rem;
    }

    .product-info p {
      margin: 0.25rem 0 0;
      color: var(--accent-color);
      font-weight: bold;
    }

    .comparison-table {
      margin-top: 1rem;
      width: 100%;
      border-collapse: collapse;
    }

    .comparison-table th,
    .comparison-table td {
      padding: 0.75rem;
      border: 1px solid #ddd;
      text-align: left;
    }

    .comparison-table th {
      background-color: var(--bg-color);
      font-weight: bold;
    }

    /* Review styles */
    .review {
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .reviews-list {
      position: relative;
      min-height: 100px;
    }

    .reviews-list.loading::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1;
    }

    .reviews-list.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 40px;
      border: 4px solid var(--accent-color);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      z-index: 2;
    }

    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .rating {
      color: #ffd700;
    }

    .rating .fa-star {
      margin-right: 2px;
    }

    .rating .fa-star.filled {
      color: #ffd700;
    }

    .review-date {
      color: #666;
      font-size: 0.9rem;
    }

    .review-text {
      margin: 0.5rem 0;
      line-height: 1.5;
    }

    .reviewer {
      color: #666;
      font-style: italic;
    }

    .add-review {
      margin-top: 2rem;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
    }

    .rating-input {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .star-rating-selector {
      display: flex;
      gap: 0.5rem;
    }

    .star-rating-selector .fa-star {
      cursor: pointer;
      font-size: 1.5rem;
      color: #ddd;
      transition: color 0.2s;
    }

    .star-rating-selector .fa-star:hover,
    .star-rating-selector .fa-star.active {
      color: #ffd700;
    }

    .add-review textarea {
      width: 100%;
      min-height: 100px;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 1rem;
      resize: vertical;
    }

    .add-review button {
      width: 100%;
      padding: 0.75rem;
      background-color: var(--accent-color);
      color: var(--white-color);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .add-review button:hover {
      background-color: var(--secondary-color);
    }

    /* Seller info styles */
    .seller-profile {
      text-align: center;
      margin-bottom: 2rem;
    }

    .seller-profile img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      margin-bottom: 1rem;
    }

    .seller-profile h3 {
      margin: 0.5rem 0;
    }

    .seller-profile p {
      margin: 0.25rem 0;
      color: #666;
    }

    .sold-products {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
    }

    .sold-product {
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }

    .sold-product img {
      width: 100%;
      height: 150px;
      object-fit: cover;
    }

    .sold-product .product-info {
      padding: 0.75rem;
    }

    .sold-product h4 {
      margin: 0;
      font-size: 1rem;
    }

    .sold-product p {
      margin: 0.25rem 0 0;
      color: var(--accent-color);
      font-weight: bold;
    }

    /* Error message styles */
    .error {
      background-color: #ffebee;
      color: #c62828;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
      text-align: center;
      border: 1px solid #ffcdd2;
    }

    .error i {
      margin-right: 0.5rem;
    }
  </style>
  <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
</head>
<body>
  <header>
    <div class="navbar">
      <div class="navlogo">
        <a href="index.html">
          <img src="Logo1.png" alt="StudXchange">
        </a>
      </div>
      <div class="search-container">
        <form class="searchbar" action="search-results.html" method="GET">
          <select name="category" class="category-select">
            <option value="all">All</option>
            <option value="VIT">VIT</option>
            <option value="COEP">COEP</option>
            <option value="PICT">PICT</option>
            <option value="DYP">DYP</option>
            <option value="PCCOE">PCCOE</option>
          </select>
          <input type="text" name="query" placeholder="Search products...">
          <button type="submit"><i class="fas fa-search"></i></button>
        </form>
      </div>
      <div class="button-container">
        <a class="wishlist-button" href="wishlist.html"><i class="fa-regular fa-heart"></i></a>
        <a class="profile-button" href="PROFILE_FINAL.html"><i class="fas fa-user"></i></a>
      </div>
    </div>
  </header>
  <main>
    <div class="product-container" id="productContainer">
      <div class="room-layout">
        <div class="product-images room-images">
          <div class="main-image-container">
            <img class="main-image" id="mainImage" alt="Main product image" />
          </div>
          <div class="thumbnails" id="thumbnails"></div>
        </div>

        <div class="product-header room-info">
          <div style="display: flex; justify-content: space-between; align-items: center">
            <h1 class="product-title" id="productTitle"></h1>
            <i class="far fa-heart wishlist-toggle" 
               onclick="toggleWishlist(currentProduct)" 
               style="font-size: 1.5rem; cursor: pointer;"></i>
          </div>
          <div class="price-section">
            <span class="current-price" id="productPrice"></span>
            <span class="original-price" id="productMRP"></span>
          </div>
          
          <!-- Room details section -->
          <div id="roomDetailsSection" style="display: none;">
            <div class="room-details" id="roomDetails">
              <!-- Room details will be dynamically populated -->
            </div>
            <div class="amenities-list" id="amenitiesList">
              <!-- Amenities will be dynamically populated -->
            </div>
          </div>
          
          <div class="action-buttons" id="actionButtons">
            <!-- Buttons will be dynamically populated based on product type -->
          </div>
        </div>
        
        <div class="product-description room-description">
          <h3>Description</h3>
          <p id="productDescription"></p>
        </div>
        
        <div id="reviewSection" style="display: none; margin-top: 2rem;">
          <h3>Reviews</h3>
          <div id="reviewsList" class="reviews-list"></div>
          <div class="add-review" style="margin-top: 1rem;">
            <h4>Add Review</h4>
            <div class="rating-input" style="margin-bottom: 1rem;">
              <span>Rating: </span>
              <div class="star-rating-selector" id="ratingStars">
                <i class="far fa-star" data-rating="1"></i>
                <i class="far fa-star" data-rating="2"></i>
                <i class="far fa-star" data-rating="3"></i>
                <i class="far fa-star" data-rating="4"></i>
                <i class="far fa-star" data-rating="5"></i>
              </div>
              <input type="hidden" id="ratingInput" value="5">
            </div>
            <textarea id="reviewText" placeholder="Write your review..." style="width: 100%; min-height: 100px; margin-bottom: 1rem;"></textarea>
            <button class="btn btn-primary" onclick="submitReview()">Submit Review</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Map Section -->
    <div class="map-card" id="mapSection" style="display: none;">
      <div class="map-header">
        <h3>Location</h3>
        <div class="map-controls">
          <button onclick="zoomIn()" class="map-control-btn"><i class="fas fa-plus"></i></button>
          <button onclick="zoomOut()" class="map-control-btn"><i class="fas fa-minus"></i></button>
        </div>
      </div>
      <div id="mapError" style="display: none;"></div>
      <div id="map" style="width: 100%; height: 400px;"></div>
    </div>

    <!-- Modals -->
    <div id="buyModal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeBuyModal()">&times;</span>
        <h2>Complete Purchase</h2>
        <div class="buyer-info">
          <div class="input-group">
            <label>Full Name</label>
            <input type="text" id="buyerName" readonly />
          </div>
          <div class="input-group">
            <label>Email Address</label>
            <input type="email" id="buyerEmail" readonly />
          </div>
          <div class="input-group">
            <label>Phone Number</label>
            <input type="tel" id="buyerPhone" readonly />
          </div>
          <button class="btn btn-primary" onclick="initiatePurchase()">
            <i class="fab fa-whatsapp"></i> Confirm via WhatsApp
          </button>
        </div>
      </div>
    </div>

    <div id="compareModal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeCompareModal()">&times;</span>
        <h2>Compare Products</h2>
        <input type="text" id="searchBar" placeholder="Search for a product..." oninput="filterProducts()">
        <div class="product-list" id="productList"></div>
        <div class="selected-products">
          <div id="selectedProduct1">Product 1: Not selected</div>
          <div id="selectedProduct2">Product 2: Not selected</div>
        </div>
        <button class="btn btn-primary" onclick="compareProducts()">Compare</button>
        <div id="comparisonTable" class="comparison-table" style="display:none;"></div>
      </div>
    </div>

    <div id="chatModal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeChatModal()">&times;</span>
        <h2>Chat with Seller</h2>
        <div class="chat-box" id="chatBox"></div>
        <div class="chat-input">
          <input type="text" id="chatMessage" placeholder="Type your message..." />
          <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>
    </div>

    <div id="sellerInfoModal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeSellerInfoModal()">&times;</span>
        <h2>Seller Information</h2>
        <div id="sellerInfoContent"></div>
        <h3>Sold Products</h3>
        <div id="soldProductsList"></div>
      </div>
    </div>
  </main>

  <footer>
    <p>For any help, contact us at: Studxchange05@gmail.com | Phone: 8857053541</p>
  </footer>

  <script>
    const JSONBIN_API_KEY = "$2a$10$dF64uklTyeOG4.4DwhQH7etxnfGEZirNkdAWk/y.oCmVqPwSEmhCG";
    const JSONBIN_BIN_ID = "67c208a8acd3cb34a8f2a982";
    const JSONBIN_CHAT_ID = "67c20bc8acd3cb34a8f2aaf6";
    const MAPTILER_API_KEY = "NORQCtupfJJ7qm57OFEU";
    
    let currentProduct = null;
    let map = null;
    let allProducts = [];
    let selectedProduct1 = null;
    let selectedProduct2 = null;

    async function fetchData() {
      try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
          headers: { 'X-Master-Key': JSONBIN_API_KEY }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        if (!data.record) {
          throw new Error('Invalid data format received from server');
        }
        
        return data.record;
      } catch (error) {
        console.error("Failed to load data:", error);
        showError('Failed to load data. Please try again later.');
        return { products: [], users: [], soldItems: [], rooms: [], reviews: {}, wishlists: {} };
      }
    }

    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error';
      errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
      document.body.appendChild(errorDiv);
      
      setTimeout(() => {
        errorDiv.remove();
      }, 5000);
    }

    async function fetchRoomDirectly(roomTitle) {
      try {
        const response = await fetch(`/api/rooms/${encodeURIComponent(roomTitle)}`);
        if (response.ok) {
          const data = await response.json();
          return Array.isArray(data) && data.length > 0 ? data[0] : data;
        }
        return null;
      } catch (error) {
        console.error("Error fetching room directly:", error);
        return null;
      }
    }

    async function loadProductDetails() {
      const urlParams = new URLSearchParams(window.location.search);
      const productTitleParam = decodeURIComponent(urlParams.get('product') || '');
      
      try {
        const data = await fetchData();
        let item = null;
        
        // Search in products collection
        if (data.products) {
          item = data.products.find(p => p.title === productTitleParam);
        }
        
        // If not found in products, check rooms collection
        if (!item && data.rooms) {
          item = data.rooms.find(r => r.title === productTitleParam);
          if (item) item.category = 'Room';
        }
        
        // Try direct room fetch if still not found
        if (!item) {
          const roomData = await fetchRoomDirectly(productTitleParam);
          if (roomData) {
            item = roomData;
            item.category = 'Room';
          }
        }
        
        currentProduct = item;
        
        if (!currentProduct) {
          console.error("Product not found:", productTitleParam);
          window.location.href = 'index.html';
          return;
        }

        // Update UI with product details
        updateProductUI(currentProduct);
        
      } catch (error) {
        console.error('Error loading product:', error);
        window.location.href = 'index.html';
      }
    }

    function updateProductUI(product) {
      // Update basic product info
      document.getElementById('productTitle').textContent = product.title;
      document.getElementById('productPrice').textContent = `₹${product.price}`;
      document.getElementById('productMRP').textContent = product.category === 'Room' ? 'per month' : `MRP: ₹${(product.price * 1.2).toFixed(2)}`;
      document.getElementById('productDescription').textContent = product.description;

      // Update images with loading state
      const mainImageContainer = document.querySelector('.main-image-container');
      const mainImage = document.getElementById('mainImage');
      const thumbnailsContainer = document.getElementById('thumbnails');
      const primaryImage = product.images?.[0] || product.image || 'placeholder.jpg';
      
      mainImageContainer.classList.add('loading');
      mainImage.src = primaryImage;
      mainImage.onload = () => {
        mainImage.classList.add('loaded');
        mainImageContainer.classList.remove('loading');
      };
      mainImage.onerror = () => {
        mainImage.src = 'placeholder.jpg';
        mainImageContainer.classList.remove('loading');
      };
      
      thumbnailsContainer.innerHTML = '';
      
      const imagesToShow = product.images?.length ? product.images : (product.image ? [product.image] : []);
      imagesToShow.forEach(imgUrl => {
        const thumb = document.createElement('img');
        thumb.src = imgUrl;
        thumb.className = 'thumbnail';
        thumb.alt = "Product thumbnail";
        thumb.onclick = () => {
          mainImageContainer.classList.add('loading');
          mainImage.src = imgUrl;
          mainImage.onload = () => {
            mainImage.classList.add('loaded');
            mainImageContainer.classList.remove('loading');
          };
          mainImage.onerror = () => {
            mainImage.src = 'placeholder.jpg';
            mainImageContainer.classList.remove('loading');
          };
        };
        thumbnailsContainer.appendChild(thumb);
      });

      // Update action buttons
      const actionButtons = document.getElementById('actionButtons');
      if (product.category === 'Room') {
        actionButtons.innerHTML = `
          <button class="btn btn-primary" onclick="contactOwner()">
            <i class="fab fa-whatsapp"></i> Contact Owner
          </button>
        `;
        
        // Show room details
        const roomDetailsSection = document.getElementById('roomDetailsSection');
        roomDetailsSection.style.display = 'block';
        
        // Update room details
        updateRoomDetails(product);
        
        // Show reviews section
        document.getElementById('reviewSection').style.display = 'block';
        loadReviews();
      } else {
        actionButtons.innerHTML = `
          <button class="btn btn-primary" onclick="openBuyModal()">
            <i class="fas fa-shopping-cart"></i> Buy Now
          </button>
          <button class="btn btn-secondary" onclick="openChatModal()">
            <i class="fas fa-comments"></i> Chat with Seller
          </button>
          <button class="btn btn-secondary" onclick="showSellerInfo()">
            <i class="fas fa-user"></i> Seller Info
          </button>
          <button class="btn btn-secondary" onclick="openCompareModal()">
            <i class="fas fa-exchange-alt"></i> Compare
          </button>
        `;
        document.getElementById('reviewSection').style.display = 'none';
        document.getElementById('roomDetailsSection').style.display = 'none';
      }

      // Update wishlist icon
      updateWishlistIcon();
    }

    function updateRoomDetails(product) {
      const roomDetails = document.getElementById('roomDetails');
      roomDetails.innerHTML = '';
      
      if (product.hostelName) {
        roomDetails.innerHTML += `
          <div class="detail-item">
            <i class="fas fa-building"></i>
            <span>${product.hostelName}</span>
          </div>
        `;
      }
      
      if (product.college) {
        roomDetails.innerHTML += `
          <div class="detail-item">
            <i class="fas fa-graduation-cap"></i>
            <span>${product.college}</span>
          </div>
        `;
      }
      
      if (product.location) {
        roomDetails.innerHTML += `
          <div class="detail-item">
            <i class="fas fa-map-marker-alt"></i>
            <span>${product.location}</span>
          </div>
        `;
      }

      // Update amenities
      const amenitiesList = document.getElementById('amenitiesList');
      amenitiesList.innerHTML = '';
      
      if (product.amenities?.length) {
        const amenityIcons = {
          'WiFi': 'fa-wifi',
          'Hot Water': 'fa-hot-tub',
          'AC': 'fa-snowflake',
          'Non-AC': 'fa-fan',
          'Mess': 'fa-utensils',
          'Security': 'fa-shield-alt',
          'Laundry': 'fa-tshirt',
          'Cleaning': 'fa-broom',
          'Parking': 'fa-parking',
          'TV': 'fa-tv',
          'Refrigerator': 'fa-refrigerator',
          'Study Table': 'fa-table',
          'Cupboard': 'fa-door-closed',
          'Power Backup': 'fa-bolt',
          'Gym': 'fa-dumbbell',
          'Cleaning Service': 'fa-broom'
        };
        
        product.amenities.forEach(amenity => {
          const iconClass = amenityIcons[amenity] || 'fa-check';
          amenitiesList.innerHTML += `
            <div class="amenity-badge">
              <i class="fas ${iconClass}"></i>
              <span>${amenity}</span>
            </div>
          `;
        });
      }
    }

    // Map functions
    async function initMap(lat, lng) {
      const mapContainer = document.getElementById('map');
      const mapError = document.getElementById('mapError');
      
      if (!lat || !lng) {
        mapError.textContent = 'Location coordinates not available';
        mapError.style.display = 'block';
        mapContainer.style.display = 'none';
        return;
      }

      try {
        mapContainer.classList.add('loading');
        mapError.style.display = 'none';
        mapContainer.style.display = 'block';

        if (map) {
          map.remove();
        }

        // Validate coordinates
        if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
          throw new Error('Invalid coordinates');
        }

        map = new maplibregl.Map({
          container: 'map',
          style: 'https://api.maptiler.com/maps/streets/style.json?key=' + MAPTILER_API_KEY,
          center: [lng, lat],
          zoom: 15,
          attributionControl: false,
          preserveDrawingBuffer: true
        });

        map.addControl(new maplibregl.NavigationControl(), 'top-right');

        // Add error event listener
        map.on('error', (e) => {
          console.error('Map error:', e);
          mapError.textContent = 'Failed to load map. Please try again later.';
          mapError.style.display = 'block';
          mapContainer.style.display = 'none';
        });

        // Add load event listener
        map.on('load', () => {
          mapContainer.classList.remove('loading');
          try {
            new maplibregl.Marker()
              .setLngLat([lng, lat])
              .addTo(map);
          } catch (markerError) {
            console.error('Error adding marker:', markerError);
            mapError.textContent = 'Failed to add location marker.';
            mapError.style.display = 'block';
          }
        });

        // Add timeout for map loading
        setTimeout(() => {
          if (mapContainer.classList.contains('loading')) {
            mapError.textContent = 'Map loading timeout. Please refresh the page.';
            mapError.style.display = 'block';
            mapContainer.style.display = 'none';
            mapContainer.classList.remove('loading');
          }
        }, 10000); // 10 second timeout

      } catch (error) {
        console.error('Error initializing map:', error);
        mapError.textContent = error.message || 'Failed to load map. Please try again later.';
        mapError.style.display = 'block';
        mapContainer.style.display = 'none';
      } finally {
        mapContainer.classList.remove('loading');
      }
    }

    function zoomIn() {
      if (map) {
        map.zoomIn();
      }
    }

    function zoomOut() {
      if (map) {
        map.zoomOut();
      }
    }

    // Modal functions
    function openBuyModal() {
      document.getElementById('buyModal').style.display = 'flex';
      // Populate buyer info from localStorage or session
      const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
      document.getElementById('buyerName').value = user.name || '';
      document.getElementById('buyerEmail').value = user.email || '';
      document.getElementById('buyerPhone').value = user.phone || '';
    }

    function closeBuyModal() {
      document.getElementById('buyModal').style.display = 'none';
    }

    function openChatModal() {
      document.getElementById('chatModal').style.display = 'flex';
      loadChatHistory();
    }

    function closeChatModal() {
      document.getElementById('chatModal').style.display = 'none';
    }

    function openCompareModal() {
      document.getElementById('compareModal').style.display = 'flex';
      loadProductsForComparison();
    }

    function closeCompareModal() {
      document.getElementById('compareModal').style.display = 'none';
    }

    function showSellerInfo() {
      document.getElementById('sellerInfoModal').style.display = 'flex';
      loadSellerInfo();
    }

    function closeSellerInfoModal() {
      document.getElementById('sellerInfoModal').style.display = 'none';
    }

    async function initiatePurchase() {
      const buyerName = document.getElementById('buyerName').value;
      const buyerPhone = document.getElementById('buyerPhone').value;
      
      if (!buyerName || !buyerPhone) {
        alert('Please fill in all required fields');
        return;
      }

      const message = `Hi, I'm interested in buying ${currentProduct.title} for ₹${currentProduct.price}`;
      const whatsappUrl = `https://wa.me/${currentProduct.sellerPhone}?text=${encodeURIComponent(message)}`;
      window.open(whatsappUrl, '_blank');
    }

    function contactOwner() {
      if (!currentProduct?.ownerPhone) {
        alert('Owner contact information not available');
        return;
      }
      const message = `Hi, I'm interested in the room at ${currentProduct.hostelName}`;
      const whatsappUrl = `https://wa.me/${currentProduct.ownerPhone}?text=${encodeURIComponent(message)}`;
      window.open(whatsappUrl, '_blank');
    }

    async function sendMessage() {
      const messageInput = document.getElementById('chatMessage');
      const message = messageInput.value.trim();
      
      if (!message) return;

      const chatBox = document.getElementById('chatBox');
      const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
      
      // Add message to chat
      chatBox.innerHTML += `
        <div class="message user-message">
          <div class="message-content">${message}</div>
        </div>
      `;
      
      messageInput.value = '';
      chatBox.scrollTop = chatBox.scrollHeight;

      try {
        // Save message to chat history
        const chatData = {
          productId: currentProduct.id,
          userId: user.id,
          message: message,
          timestamp: new Date().toISOString()
        };

        const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_CHAT_ID}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Master-Key': JSONBIN_API_KEY
          },
          body: JSON.stringify({
            record: [...(await getChatHistory()), chatData]
          })
        });

        if (!response.ok) throw new Error('Failed to save message');
      } catch (error) {
        console.error('Error saving message:', error);
      }
    }

    async function loadChatHistory() {
      const chatBox = document.getElementById('chatBox');
      chatBox.innerHTML = '<div class="loading">Loading chat history...</div>';
      
      try {
        const history = await getChatHistory();
        const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
        
        chatBox.innerHTML = history
          .filter(msg => msg.productId === currentProduct.id)
          .map(msg => `
            <div class="message ${msg.userId === user.id ? 'user-message' : 'seller-message'}">
              <div class="message-content">${msg.message}</div>
            </div>
          `)
          .join('');
        
        chatBox.scrollTop = chatBox.scrollHeight;
      } catch (error) {
        console.error('Error loading chat history:', error);
        chatBox.innerHTML = '<div class="error">Failed to load chat history</div>';
      }
    }

    async function getChatHistory() {
      try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_CHAT_ID}`, {
          headers: { 'X-Master-Key': JSONBIN_API_KEY }
        });
        const data = await response.json();
        return data.record || [];
      } catch (error) {
        console.error('Error fetching chat history:', error);
        return [];
      }
    }

    async function loadProductsForComparison() {
      const productList = document.getElementById('productList');
      productList.innerHTML = '<div class="loading">Loading products...</div>';
      
      try {
        const data = await fetchData();
        const products = data.products.filter(p => p.id !== currentProduct.id);
        
        productList.innerHTML = products.map(p => `
          <div class="product-item" onclick="selectProductForComparison(${p.id})">
            <img src="${p.images?.[0] || p.image}" alt="${p.title}">
            <div class="product-info">
              <h4>${p.title}</h4>
              <p>₹${p.price}</p>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading products:', error);
        productList.innerHTML = '<div class="error">Failed to load products</div>';
      }
    }

    function selectProductForComparison(productId) {
      if (!selectedProduct1) {
        selectedProduct1 = productId;
        document.getElementById('selectedProduct1').textContent = `Product 1: ${getProductTitle(productId)}`;
      } else if (!selectedProduct2 && productId !== selectedProduct1) {
        selectedProduct2 = productId;
        document.getElementById('selectedProduct2').textContent = `Product 2: ${getProductTitle(productId)}`;
      }
    }

    function getProductTitle(productId) {
      const product = allProducts.find(p => p.id === productId);
      return product ? product.title : 'Unknown Product';
    }

    async function compareProducts() {
      if (!selectedProduct1 || !selectedProduct2) {
        alert('Please select two products to compare');
        return;
      }

      const product1 = allProducts.find(p => p.id === selectedProduct1);
      const product2 = allProducts.find(p => p.id === selectedProduct2);

      if (!product1 || !product2) {
        alert('Error: Products not found');
        return;
      }

      const comparisonTable = document.getElementById('comparisonTable');
      comparisonTable.style.display = 'block';
      comparisonTable.innerHTML = `
        <table>
          <tr>
            <th>Features</th>
            <th>${product1.title}</th>
            <th>${product2.title}</th>
          </tr>
          <tr>
            <td>Price</td>
            <td>₹${product1.price}</td>
            <td>₹${product2.price}</td>
          </tr>
          <tr>
            <td>Category</td>
            <td>${product1.category}</td>
            <td>${product2.category}</td>
          </tr>
          <tr>
            <td>Condition</td>
            <td>${product1.condition}</td>
            <td>${product2.condition}</td>
          </tr>
          <tr>
            <td>Description</td>
            <td>${product1.description}</td>
            <td>${product2.description}</td>
          </tr>
        </table>
      `;
    }

    function filterProducts() {
      const searchTerm = document.getElementById('searchBar').value.toLowerCase();
      const productItems = document.querySelectorAll('.product-item');
      
      productItems.forEach(item => {
        const title = item.querySelector('h4').textContent.toLowerCase();
        item.style.display = title.includes(searchTerm) ? 'flex' : 'none';
      });
    }

    async function loadSellerInfo() {
      const sellerInfoContent = document.getElementById('sellerInfoContent');
      const soldProductsList = document.getElementById('soldProductsList');
      
      if (!currentProduct?.sellerId) {
        sellerInfoContent.innerHTML = '<p>Seller information not available</p>';
        return;
      }

      try {
        const data = await fetchData();
        const seller = data.users.find(u => u.id === currentProduct.sellerId);
        
        if (!seller) {
          sellerInfoContent.innerHTML = '<p>Seller not found</p>';
          return;
        }

        sellerInfoContent.innerHTML = `
          <div class="seller-profile">
            <img src="${seller.profileImage || 'default-avatar.png'}" alt="Seller profile">
            <h3>${seller.name}</h3>
            <p>${seller.email}</p>
            <p>${seller.phone}</p>
            <p>Member since: ${new Date(seller.joinDate).toLocaleDateString()}</p>
          </div>
        `;

        // Load sold products
        const soldProducts = data.soldItems.filter(item => item.sellerId === seller.id);
        soldProductsList.innerHTML = soldProducts.map(item => `
          <div class="sold-product">
            <img src="${item.image}" alt="${item.title}">
            <div class="product-info">
              <h4>${item.title}</h4>
              <p>Sold for: ₹${item.price}</p>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading seller info:', error);
        sellerInfoContent.innerHTML = '<p>Failed to load seller information</p>';
      }
    }

    async function toggleWishlist(product) {
      if (!product) return;
      
      const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
      if (!user.id) {
        alert('Please login to add items to wishlist');
        return;
      }

      try {
        const data = await fetchData();
        const wishlist = data.wishlists?.[user.id] || [];
        const isInWishlist = wishlist.includes(product.id);

        if (isInWishlist) {
          wishlist.splice(wishlist.indexOf(product.id), 1);
        } else {
          wishlist.push(product.id);
        }

        // Update wishlist in database
        const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Master-Key': JSONBIN_API_KEY
          },
          body: JSON.stringify({
            record: {
              ...data,
              wishlists: {
                ...data.wishlists,
                [user.id]: wishlist
              }
            }
          })
        });

        if (!response.ok) throw new Error('Failed to update wishlist');
        
        updateWishlistIcon();
      } catch (error) {
        console.error('Error updating wishlist:', error);
        alert('Failed to update wishlist');
      }
    }

    async function updateWishlistIcon() {
      const wishlistIcon = document.querySelector('.wishlist-toggle');
      if (!wishlistIcon || !currentProduct) return;

      const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
      if (!user.id) {
        wishlistIcon.className = 'far fa-heart wishlist-toggle';
        return;
      }

      try {
        const data = await fetchData();
        const wishlist = data.wishlists?.[user.id] || [];
        const isInWishlist = wishlist.includes(currentProduct.id);
        
        wishlistIcon.className = isInWishlist ? 'fas fa-heart wishlist-toggle' : 'far fa-heart wishlist-toggle';
      } catch (error) {
        console.error('Error updating wishlist icon:', error);
      }
    }

    async function loadReviews() {
      const reviewsList = document.getElementById('reviewsList');
      reviewsList.classList.add('loading');
      
      try {
        const data = await fetchData();
        const reviews = data.reviews?.[currentProduct.id] || [];
        
        reviewsList.innerHTML = reviews.length ? reviews.map(review => `
          <div class="review">
            <div class="review-header">
              <div class="rating">
                ${Array(5).fill().map((_, i) => `
                  <i class="fas fa-star ${i < review.rating ? 'filled' : ''}"></i>
                `).join('')}
              </div>
              <span class="review-date">${new Date(review.date).toLocaleDateString()}</span>
            </div>
            <p class="review-text">${review.text}</p>
            <p class="reviewer">- ${review.userName}</p>
          </div>
        `).join('') : '<p>No reviews yet</p>';
      } catch (error) {
        console.error('Error loading reviews:', error);
        reviewsList.innerHTML = '<div class="error">Failed to load reviews</div>';
      } finally {
        reviewsList.classList.remove('loading');
      }
    }

    async function submitReview() {
      const rating = parseInt(document.getElementById('ratingInput').value);
      const reviewText = document.getElementById('reviewText').value.trim();
      
      if (!rating || !reviewText) {
        alert('Please provide both rating and review text');
        return;
      }

      const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
      if (!user.id) {
        alert('Please login to submit a review');
        return;
      }

      try {
        const data = await fetchData();
        const reviews = data.reviews || {};
        const productReviews = reviews[currentProduct.id] || [];
        
        const newReview = {
          rating,
          text: reviewText,
          userName: user.name,
          date: new Date().toISOString()
        };

        productReviews.push(newReview);
        reviews[currentProduct.id] = productReviews;

        // Update reviews in database
        const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Master-Key': JSONBIN_API_KEY
          },
          body: JSON.stringify({
            record: {
              ...data,
              reviews
            }
          })
        });

        if (!response.ok) throw new Error('Failed to submit review');

        // Clear form and reload reviews
        document.getElementById('reviewText').value = '';
        loadReviews();
      } catch (error) {
        console.error('Error submitting review:', error);
        alert('Failed to submit review');
      }
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', () => {
      loadProductDetails();
      
      // Initialize chat message input
      document.getElementById('chatMessage').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });

      // Initialize star rating selector
      const ratingStars = document.getElementById('ratingStars');
      const ratingInput = document.getElementById('ratingInput');
      
      ratingStars.addEventListener('click', (e) => {
        const star = e.target.closest('.fa-star');
        if (!star) return;
        
        const rating = parseInt(star.dataset.rating);
        ratingInput.value = rating;
        
        // Update star display
        ratingStars.querySelectorAll('.fa-star').forEach((s, i) => {
          s.className = i < rating ? 'fas fa-star' : 'far fa-star';
        });
      });
    });
  </script>
</body>
</html> 